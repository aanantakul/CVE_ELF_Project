<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <link rel="stylesheet" href="https://ssl.gstatic.com/docs/script/css/add-ons1.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
      body { padding: 0; font-family: 'Roboto', sans-serif; background: #f0f2f5; color: #333; }
      
      /* --- HEADER & TABS --- */
      .sticky-header { position: sticky; top: 0; z-index: 100; background: #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
      .tab-header { display: flex; border-bottom: 1px solid #ddd; }
      
      .tab-btn {
        flex: 1; 
        display: flex; justify-content: center; align-items: center;
        padding: 12px 5px; 
        font-size: 13px;   
        border: none; background: none; font-weight: 700; color: #666; cursor: pointer;
        border-bottom: 3px solid transparent; transition: 0.2s;
        white-space: nowrap; overflow: hidden;
      }
      .tab-btn.active { color: #1a73e8; border-bottom-color: #1a73e8; }
      
      .content { padding: 12px; padding-bottom: 80px; }
      
      /* --- INPUT GROUPS --- */
      .section-title { font-size: 12px; font-weight: 700; text-transform: uppercase; color: #5f6368; margin: 15px 0 8px 0; letter-spacing: 0.5px; }
      .input-group { background: #fff; border-radius: 8px; padding: 12px; border: 1px solid #dadce0; margin-bottom: 10px; }
      .input-label { display: block; font-size: 11px; font-weight: 700; color: #1a73e8; margin-bottom: 4px; }
      .text-input { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 13px; box-sizing: border-box; }
      
      /* --- DYNAMIC FLOOR CARD --- */
      .floor-list { display: flex; flex-direction: column-reverse; gap: 10px; }
      
      .floor-card {
        background: #fff; border-radius: 8px; border-left: 5px solid #1a73e8;
        padding: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); position: relative;
        animation: slideIn 0.3s ease-out;
      }
      /* Roof Style */
      .floor-card.is-roof { border-left-color: #d93025; }
      
      /* [‡πÉ‡∏´‡∏°‡πà] ‡∏ã‡πà‡∏≠‡∏ô Input Height ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô Roof ‡πÅ‡∏ï‡πà‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏ß‡πâ (visibility: hidden) ‡πÄ‡∏û‡∏∑‡πà‡∏≠ layout ‡πÑ‡∏°‡πà‡∏û‡∏±‡∏á */
      .floor-card.is-roof .col-height-wrapper { visibility: hidden; }

      .floor-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
      .floor-title { font-weight: 700; font-size: 14px; color: #202124; }
      .floor-card.is-roof .floor-title { color: #d93025; } 

      .btn-delete { background: none; border: none; color: #d93025; cursor: pointer; font-size: 16px; padding: 4px; border-radius: 50%; }
      .btn-delete:hover { background: #fce8e6; }
      
      .row-inputs { display: flex; gap: 8px; }
      .col { flex: 1; }
      .mini-label { font-size: 10px; color: #5f6368; margin-bottom: 2px; display: block; white-space: nowrap; }
      .num-input { width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px; box-sizing: border-box; }
      .num-input:focus { border-color: #1a73e8; outline: none; }

      /* --- FOOTER ACTIONS --- */
      .footer-actions {
        position: fixed; bottom: 0; left: 0; right: 0;
        background: #fff; padding: 10px; border-top: 1px solid #ddd;
        display: flex; gap: 10px; z-index: 200;
      }
      
      .btn-add { 
        flex: 1; display: flex; justify-content: center; align-items: center;
        background: #e8f0fe; color: #1a73e8; border: none; padding: 10px 5px;
        border-radius: 4px; font-weight: 700; font-size: 13px; cursor: pointer; white-space: nowrap;
      }
      .btn-add:hover { background: #d2e3fc; }
      
      .btn-generate { 
        flex: 2; display: flex; justify-content: center; align-items: center;
        background: #1a73e8; color: white; border: none; padding: 10px 5px;
        border-radius: 4px; font-weight: 700; font-size: 13px; cursor: pointer; 
        box-shadow: 0 2px 5px rgba(0,0,0,0.2); white-space: nowrap;
      }
      .btn-generate:hover { background: #1557b0; }
      
      @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
      .error-msg { color: #d93025; font-size: 12px; text-align: center; margin-top: 5px; display: none; }
    </style>
  </head>
  <body>

    <div class="sticky-header">
      <div class="tab-header">
        <button class="tab-btn active">üèóÔ∏è Structure Manager</button>
      </div>
    </div>

    <div class="content">
      
      <div class="section-title">Grid Configuration</div>
      
      <div class="input-group">
        <label class="input-label">SPAN X (Horizontal Bays)</label>
        <input type="text" id="globalSpanX" class="text-input" value="4,4,4" placeholder="e.g. 4,4,4">
      </div>
      <div class="input-group">
        <label class="input-label">SPAN Y (Building Depth)</label>
        <input type="text" id="globalSpanY" class="text-input" value="4,3,4" placeholder="e.g. 4,3">
      </div>

      <div class="section-title" style="display:flex; justify-content:space-between;">
        <span>Levels (Floors & Roof)</span>
        <span style="font-size:10px; color:#999; font-weight:normal;">Sorted: Bottom to Top</span>
      </div>
      
      <div id="floorContainer" class="floor-list">
        </div>
      
      <div id="errorMsg" class="error-msg"></div>

    </div>

    <div class="footer-actions">
      <button class="btn-add" onclick="addNewFloor()">+ Add Level</button>
      <button class="btn-generate" onclick="collectAndGenerate()">üöÄ Draw Blueprint</button>
    </div>

    <script>
      let floorCount = 0;

      function addNewFloor(defaultHeight = 3.5, defaultLoad = 1.5, defaultPoint = 0) {
        floorCount++;
        const container = document.getElementById('floorContainer');
        const div = document.createElement('div');
        div.className = 'floor-card';
        div.id = 'floor-' + floorCount;
        
        div.innerHTML = `
          <div class="floor-header">
            <span class="floor-title">Level ${floorCount}</span>
            <button class="btn-delete" onclick="removeFloor(this)" title="Remove this floor">‚úï</button>
          </div>
          <div class="row-inputs">
            <div class="col col-height-wrapper">
              <span class="mini-label">Col Height (m)</span>
              <input type="number" step="0.1" class="num-input inp-height" value="${defaultHeight}">
            </div>
            <div class="col">
              <span class="mini-label">Load (T/m)</span>
              <input type="number" step="0.1" class="num-input inp-load" value="${defaultLoad}">
            </div>
            <div class="col">
              <span class="mini-label">Point Load</span>
              <input type="number" step="0.1" class="num-input inp-point" value="${defaultPoint}">
            </div>
          </div>
        `;
        container.appendChild(div);
        updateFloorLabels();
      }

      function removeFloor(btn) {
        const card = btn.closest('.floor-card');
        card.remove();
        updateFloorLabels();
      }

      function updateFloorLabels() {
        const cards = document.querySelectorAll('.floor-card');
        floorCount = cards.length;
        
        cards.forEach((card, index) => {
          const title = card.querySelector('.floor-title');
          
          // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÉ‡∏ö‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢ ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô Roof ‡πÅ‡∏•‡∏∞‡∏ã‡πà‡∏≠‡∏ô Height Input
          if (index === cards.length - 1) {
             title.textContent = `Roof / Deck (Top)`;
             card.classList.add('is-roof'); 
          } else {
             title.textContent = `Floor ${index + 1}`;
             card.classList.remove('is-roof');
          }
        });
      }

      function collectAndGenerate() {
        const btn = document.querySelector('.btn-generate');
        const errorMsg = document.getElementById('errorMsg');
        
        const spanX = document.getElementById('globalSpanX').value;
        const spanY = document.getElementById('globalSpanY').value;
        const cards = document.querySelectorAll('.floor-card');
        
        if (cards.length === 0) {
          errorMsg.textContent = "Please add at least 1 level.";
          errorMsg.style.display = 'block';
          return;
        }

        let heightsArr = [];
        let loadsArr = [];
        let pointsArr = [];

        cards.forEach((card, index) => {
          const h = card.querySelector('.inp-height').value || 0;
          const l = card.querySelector('.inp-load').value || 0;
          const p = card.querySelector('.inp-point').value || 0;
          
          // Logic: ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÉ‡∏ö‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢ (Roof) ‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡πÑ‡∏°‡πà‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡πà‡∏≤ Height ‡∏™‡πà‡∏á‡πÑ‡∏õ 
          // ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô Height = ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ä‡∏±‡πâ‡∏ô ‡πÅ‡∏ï‡πà Load ‡∏°‡∏µ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ö ‡∏Ñ‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏ä‡∏±‡πâ‡∏ô+‡∏´‡∏•‡∏±‡∏á‡∏Ñ‡∏≤)
          if (index < cards.length - 1) {
            heightsArr.push(h);
          }
          
          // ‡πÅ‡∏ï‡πà Load ‡πÅ‡∏•‡∏∞ PointLoad ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡∏≠‡∏á Roof ‡∏î‡πâ‡∏ß‡∏¢
          loadsArr.push(l);
          pointsArr.push(p);
        });

        const heightStr = heightsArr.join(',');
        const loadsStr = loadsArr.join(',');
        const pointsStr = pointsArr.join(',');

        btn.disabled = true;
        btn.textContent = "Processing...";
        errorMsg.style.display = 'none';

        google.script.run
          .withSuccessHandler(() => {
            btn.disabled = false;
            btn.textContent = "üöÄ Draw Blueprint";
          })
          .withFailureHandler((err) => {
            btn.disabled = false;
            btn.textContent = "Retry";
            errorMsg.textContent = "Error: " + err.message;
            errorMsg.style.display = 'block';
          })
          .receiveFormInput(spanX, heightStr, loadsStr, spanY, pointsStr);
      }

      window.onload = function() {
        addNewFloor(3.5, 1.5, 1.4); // Floor 1
        addNewFloor(3.5, 2.0, 1.4); // Floor 2
        addNewFloor(0, 1.0, 1.0);   // Roof (Height ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏™‡πà‡∏Å‡πá‡πÑ‡∏î‡πâ ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏ñ‡∏π‡∏Å‡∏ã‡πà‡∏≠‡∏ô‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏™‡πà‡∏á‡πÑ‡∏õ)
      };
    </script>
  </body>
</html>